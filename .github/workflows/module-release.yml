name: Build & Release Self-Contained Module

on:
  workflow_dispatch:
  push:
    tags: [ "module-v*" ]
    branches: [ "module" ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --workspaces --include-workspace-root
      
      - name: Build self-contained module
        run: npm run build:module
      
      - name: Create module ZIP
        run: |
          echo "📦 Creating self-contained module ZIP..."
          cd packages/foundry-module
          
          # Create ZIP excluding source files and build artifacts
          zip -r ../../foundry-mcp-bridge.zip . \
            -x ".*" \
            -x "src/*" \
            -x "node_modules/*" \
            -x "tsconfig.json" \
            -x "package.json"
          
          cd ../..
          
          # Verify ZIP was created
          if [ -f "foundry-mcp-bridge.zip" ]; then
            SIZE=$(du -h foundry-mcp-bridge.zip | cut -f1)
            echo "✅ Module ZIP created ($SIZE)"
            unzip -l foundry-mcp-bridge.zip | head -20
          else
            echo "❌ Module ZIP creation failed"
            exit 1
          fi
      
      - name: Extract version from module.json
        id: version
        run: |
          VERSION=$(node -p "require('./packages/foundry-module/module.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "📦 Module version: $VERSION"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: foundry-mcp-bridge-${{ steps.version.outputs.version }}
          path: foundry-mcp-bridge.zip
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/module-v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Foundry MCP Bridge (Self-Contained) ${{ github.ref_name }}
          body: |
            ## 🎉 Self-Contained Foundry MCP Bridge
            
            **Single manifest URL installation - MCP server bundled inside!**
            
            ### 📦 Installation
            
            Install directly in Foundry VTT using this manifest URL:
            ```
            https://raw.githubusercontent.com/ctbritt/foundry-vtt-mcp/module/packages/foundry-module/module.json
            ```
            
            Or download `foundry-mcp-bridge.zip` and install manually.
            
            ### 🚀 Quick Start
            
            1. **Install Module** in Foundry VTT (via manifest URL or manual ZIP)
            2. **Enable Module** in Module Management
            3. **Start MCP Server**:
               ```bash
               cd Data/modules/foundry-mcp-bridge
               ./scripts/start-server.sh
               ```
            4. **Configure Claude Desktop**:
               ```json
               {
                 "mcpServers": {
                   "foundry-mcp": {
                     "command": "node",
                     "args": ["path/to/modules/foundry-mcp-bridge/dist/mcp-server/index.js"]
                   }
                 }
               }
               ```
            5. **Optional: Configure RunPod/S3** via module UI or `.env` file
            
            ### ✨ What's Included
            
            - ✅ Foundry VTT module (frontend)
            - ✅ MCP server (backend) with all dependencies
            - ✅ Helper scripts (start-server.sh/bat)
            - ✅ RunPod serverless integration
            - ✅ S3 storage support
            - ✅ AI battlemap generation
            
            ### 📋 Features
            
            - **Core MCP Bridge**: AI-powered actor creation, quest generation, compendium search
            - **AI Battlemap Generation**: RunPod serverless ComfyUI integration
            - **S3 Storage**: Cloud storage for generated maps
            - **Auto-Scene Creation**: Maps automatically attach to Foundry scenes
            - **20+ MCP Tools**: Comprehensive Foundry VTT integration
            
            ### 🆕 What's New in Self-Contained Module
            
            - **Single Installation**: One manifest URL gives you everything
            - **Always In Sync**: Module and server are always version-matched
            - **Easier Updates**: Update module = update server
            - **No Separate Install**: No need to clone repo or run npm install
            
            ---
            
            **Documentation**: https://github.com/ctbritt/foundry-vtt-mcp  
            **Issues**: https://github.com/ctbritt/foundry-vtt-mcp/issues  
            **Original Project**: https://github.com/adambdooley/foundry-vtt-mcp by Adam Dooley
            
            **Version**: ${{ steps.version.outputs.version }}
          files: |
            foundry-mcp-bridge.zip
            packages/foundry-module/module.json
          generate_release_notes: true
          draft: false
          prerelease: false

